---
layout: post
title:  "Debugging With Symbols"
date:   2014-08-31 14:36:23
---
#使用符号表进行调试

####使用微软提供的符号表服务或个人的符号表来调试可执行文件或操作系统。

一、符号
-------
许多不同类型的符号可用于调试。它们包括CodeView、COFF、DBG、SYM、PDB等符号，甚至从二进制文件导出表生成的导出符号。本白皮书仅讨论VS.NET和PDB格式符号，因为它们是最新的首选格式。对于使用Visual Studio编译的项目，它们是默认生成的。

为发布可执行文件生成PDB文件不会影响任何优化，也不会显着更改生成文件的大小。通常，唯一的区别是路径，PDB文件的文件名嵌入在可执行文件中。因此，您应该始终生成PDB文件，即使您不希望随可执行文件一起发货。

如果使用/ Zi或/ ZI（生产PDB信息）编译器开关以及/ DEBUG（生成调试信息）链接器开关构建项目，则会生成PDB文件。编译器生成的PDB文件被组合并写入到与可执行文件放在同一目录中的单个PDB文件中。

默认情况下，PDB文件包含以下信息：

公共符号（通常是所有函数，静态和全局变量）
*   负责可执行文件中代码段的目标文件列表
*   帧指针优化信息（FPO）
*   局部变量和数据结构的名称和类型信息
*   源文件和行号信息

如果您担心人们使用PDB文件信息来帮助他们反向工程您的可执行文件，您还可以使用/ PDBSTRIPPED：filename链接器选项生成剥离的PDB文件。如果您有要从中删除私有信息的现有PDB文件，则可以使用名为pdbcopy的工具，该工具是Windows的调试工具的一部分。

默认情况下，剥离的PDB文件包含以下信息：

*   公共符号（通常只有非静态函数和全局变量）
*   负责可执行文件中代码段的目标文件列表
*   帧指针优化信息（FPO）

这是允许可靠调试所需的最少信息。最低限度的信息也使得很难获得有关原始源代码的任何其他信息。因为生成了剥离的PDB文件和常规PDB文件，您可以向可能需要有限调试功能的用户提供剥离版本，但保留完整的PDB。请注意，/ PDBSTRIPPED生成第二个较小的PDB文件，因此，当生成构建以广泛分发时，请确保使用正确的PDB文件。对于典型的项目，常规PDB可以是几兆字节的大小，但是PDB的剥离版本可以仅仅是几百千字节。

二、使用符号表进行调试
-------

当您调试的应用程序崩溃时，调试器会尝试向您显示堆栈中导致崩溃的函数。如果没有PDB文件，调试器无法解析函数名，参数或存储在堆栈中的任何局部变量。如果你调试32位可执行文件，有些情况下没有符号你甚至不能得到可靠的堆栈跟踪。有时，可以查看堆栈上的原始值，并确定哪些值可能是返回地址，但这些值很容易与函数引用或数据混淆。

如果通过使用省略帧指针（/ Oy）优化来编译当前堆栈上的函数，并且如果不存在符号，则调试器不能可靠地确认当前函数。这是因为没有PDB包含的帧指针优化（FPO）信息，调试器不能依靠帧指针寄存器（EBP）指向保存的先前帧指针和父函数的返回地址。如果您看到有关缺少符号或没有加载符号的警告，请不要从该点向下信任堆栈。


在许多情况下，可以继续调试而不使用符号，因为问题在于具有准确符号的位置，并且您不需要在调用堆栈中进一步查看函数。即使调用堆栈中的库没有可用的PDB，只要它们用帧指针编译，调试器应该能够在父函数处正确猜测。从Windows XP Service Pack 2开始，所有Windows DLL和可执行文件都在禁用FPO的情况下进行编译，因为它使调试更准确。禁用FPO还允许采样分析器在运行时走过堆栈，对性能影响最小。在Windows XP SP2之前的Windows版本上，所有操作系统二进制文件都需要包含FPO信息的匹配符号文件，以便进行精确调试和分析。

如果调试64位本机可执行文件，则不需要符号文件来生成有效的堆栈跟踪，因为x64操作系统和编译器被设计为不需要它们。但是，您仍然需要符号文件来检索函数名称，调用参数和局部变量。

然而，有些情况下如果没有符号将难以调试。例如，如果你调试一个程序，你建立了一个PDB文件，如果你在DLL中的一个函数的回调崩溃，你没有符号，你将无法看到哪个函数引起回调，因为你将无法解码堆栈。这通常发生在第三方库（如果未提供PDB）或旧操作系统组件（如果PDB不可用）中。回调通常发生在消息传递，枚举，内存分配或异常处理期间。在没有精确堆栈的情况下调试这些函数可能令人沮丧。

要可靠地调试在不同计算机上生成的小型转储或者在不具有的代码中崩溃的小型转储，必须能够访问小型转储中引用的可执行文件的所有符号和二进制文件。如果符号和二进制文件可从符号服务器获得，则它们由调试器自动获取。有关小型转储的更多信息，请参阅崩溃转储分析白皮书。

三、获取需要的符号文件
-------------------
Visual Studio和其他Microsoft调试器（如WinDbg）通常设置为只在您构建应用程序并在自己的计算机上调试它时才工作。如果您需要将可执行文件提供给其他人，如果您的计算机上有多个版本的DLL或.exe文件，或者您想要精确调试使用Windows或其他库（如DirectX）的应用程序，则需要以了解调试器如何查找和加载符号。调试器使用由用户指定的符号搜索路径（在Visual Studio中的Options \ Debugging \ Symbols中找到）或_NT_SYMBOL_PATH环境变量。通常，调试器在以下位置中搜索匹配的PDB：

*   在DLL或可执行文件中指定的位置。
*   如果您在计算机上构建了一个DLL或可执行文件，默认情况下，链接器将相关PDB文件的完整路径和文件名放在DLL或可执行文件中。当您调试时，调试器首先检查符号文件是否存在于DLL或可执行文件中指定的位置。这是有帮助的，因为你总是有符号可用于您编译在计算机上的代码。
*   PDB可能与DLL或可执行文件存在于同一文件夹中。
*   任何本地符号缓存文件夹。
*   任何本地网络文件共享符号服务器。
*   任何Internet符号服务器，如Microsoft符号服务器。

为了确保您具有准确调试所需的所有PDB，请安装Windows的调试工具。 32位和64位版本可以在http://www.microsoft.com/whdc/devtools/debugging/default.mspx找到。

与此软件包一起安装的一个有用的工具是symchk.exe。它可以帮助识别缺失或不正确的符号。此工具有大量的潜在命令行选项。这里有两个更有用和常用的。

1、检查给定的DLL或.exe文件和PDB在同一个文件夹是否匹配

"c:\Program Files\Debugging Tools for Windows\symchk" testing.dll /s

/ s选项指示symchk仅在当前文件夹中查找符号，而不在任何符号服务器中查找。
检查一组文件夹中的所有DLL和可执行文件是否具有匹配的PDB

2、"c:\Program Files\Debugging Tools for Windows\symchk" *.* /r

/ r选项设置symchk递归遍历文件夹，以检查所有可执行文件是否具有匹配的PDB。如果没有/ s选项，symchk将使用当前的_NT_SYMBOL_PATH来搜索任何专用或本地服务器或Microsoft符号服务器上的符号。 symchk工具仅搜索可执行文件（.exe，.dll和类似文件）的符号。您不能使用通配符搜索不可执行文件的符号。


四、symchk的工作原理
------------------
当链接器生成.dll，可执行文件和PDB文件时，它在每个文件中存储相同的GUID。工具使用GUID来确定给定的PDB文件是否与DLL或可执行文件匹配。如果更改DLL或可执行文件（通过使用资源编辑器或复制保护编码或更改其版本信息），GUID将更新，并且调试器无法加载PDB文件。因此，避免在链接器创建DLL或可执行文件后操作非常重要。

您还可以使用VS.NET附带的DUMPBIN实用程序来显示搜索符号路径，以及查看符合给定DLL或可执行文件的符号文件。例如：

DUMPBIN / PDBPATH：VERBOSE filename.exe



五、符号服务器
------------
符号服务器是可执行文件和符号文件的多个版本的存储库。它包含符号文件本身或指向相关符号文件的指针。调试器了解如何使用符号服务器，并可以使用它们搜索丢失或未知符号。

DLL和可执行文件也可从Microsoft符号服务器。这使得可以调试崩溃并检查操作系统文件的代码，这些文件可能不存在于您的机器上。如果调试器遇到可用于调试的系统上不存在的可执行文件或DLL，则会自动从Microsoft符号服务器请求二进制文件的符号和副本。如果您正在调试具有许多版本的组件（例如msvcrt.dll），并且需要检查计算机上不存在的版本的代码，这将非常有用。这还有助于调试在与用于调试的系统不同的操作系统上生成的小型转储。

Microsoft在其外部可访问的符号服务器上发布所有操作系统和其他重新分发的组件（如DirectX SDK）的所有PDB文件。这使得调试使用这些DLL或可执行文件的应用程序变得容易。您可以使用Microsoft符号服务器来解析符号，以及在计算机上构建的组件的任何本地符号。

您可以将计算机设置为使用Microsoft符号服务器，您可以访问所有Microsoft符号文件。您还可以为您的公司，团队或网络设置专用符号服务器，可用于存储正在处理的项目的多个旧版本，或者为从Microsoft符号使用的符号提供本地缓存服务器。

要使用符号服务器，请在名为_NT_SYMBOL_PATH的环境变量中指定搜索路径。调试器和现代工具（如WinDbg，NTSD或Visual Studio）自动使用此路径搜索符号。

当调试器搜索符号时，它首先在本地搜索。然后它在符号服务器上查找。当它找到匹配的符号时，它将符号文件传输到本地缓存。典型DLL或可执行文件的符号的大小范围为1到100 MB。因此，如果要调试包含许多DLL的进程，则可能需要一些时间来解析所有符号并将其传输到本地缓存。
使用Microsoft符号服务器

Microsoft符号服务器允许您获取所有最新的符号，包括修补或更新文件的符号。 Microsoft符号服务器位于http://msdl.microsoft.com/download/symbols。

您可以通过以下方式之一访问符号服务器：

*   直接输入服务器地址。在Visual Studio中，从工具菜单中选择选项，然后选择调试，然后选择符号。

*   使用环境变量_NT_SYMBOL_PATH。我们推荐这种方法。

*   这被所有调试工具使用。它也被Visual Studio使用，并且在Visual Studio打开时被读取和解码。因此，如果您更改它，您需要重新启动Visual Studio。

*   此环境变量允许您指定多个符号服务器，例如，内部专用符号服务器。它还允许您指定一个本地缓存目录来存储从符号服务器在内部和通过Internet查找的所有符号的PDB。

_NT_SYMBOL_PATH变量的语法为：

srv * [local cache] * [private symbol server] * https：//msdl.microsoft.com/download/symbols

将[本地缓存]替换为计算机上要存储所使用的任何符号缓存的目录的名称，例如％SYSTEMROOT％\ Symbols或c：\ symbols。

[私有符号服务器]是可选的。它可以指向位于网络上的符号服务器，也可以指向由您的团队，产品组或公司共享的符号服务器。

要仅使用Microsoft符号服务器以及符号的本地高速缓存，要加速通过Internet访问，请对_NT_SYMBOL_PATH使用以下设置：

srv * c：\ symbols * https：//msdl.microsoft.com/download/symbols

您可以在随Microsoft调试工具Windows程序包安装的帮助文件中找到_NT_SYMBOL_PATH的其他选项。

没有符号的可执行文件可以增加启动调试器所需的时间（如果使用符号服务器）。这是因为调试器在每次尝试加载可执行文件时查询符号服务器。因此，最好总是请求所有组件的符号。

可能无法为每个组件请求符号，例如，视频驱动程序可能在进程空间中具有DLL，并且所需的PDB文件在Microsoft符号服务器上可用。在这种情况下，当您启动调试会话时有一个小的延迟。

为了避免这种小的延迟，您可以运行调试器一次，从Microsoft符号服务器本地缓存所有符号。 然后，修改您的_NT_SYMBOL_PATH以删除Microsoft符号服务器。 除非可执行文件更改，检查不具有符号的可执行文件不需要通过Internet进行查询，因为您具有Microsoft符号服务器所需的所有符号的本地缓存副本。


六、手动获取符号
------------------
如果已正确设置调试器，它会自动从本地缓存或符号服务器加载所需的任何符号。如果你想获得一个可执行文件的符号，或者一个可执行文件的文件夹，你可以使用symchk。例如，如果要将Windows System文件夹中d3dx9_30.dll文件的符号下载到当前目录中，可以使用以下命令：

“c：\ Program Files \ Windows调试工具\ symchk”c：\ Windows \ System32 \ d3dx9_30.dll / oc \。

symchk工具有许多其他用途。有关详细信息，请参阅symchk /？，或查看Microsoft调试工具Windows文档。

##设置符号服务器

设置符号服务器非常简单，有以下原因：

*   节省带宽，或加快贵公司，团队或产品的符号解析速度。在网络上的本地文件共享上的内部符号服务器缓存对外部符号服务器（如Microsoft符号服务器）的任何引用。许多人可以同时快速访问本地或内部符号服务器。因此，它节省带宽和重复符号请求可以创建的延迟。
*   存储应用程序的旧版本，版本或外部版本的符号。通过将这些构建的符号存储在您可以轻松访问的符号服务器上，您可以在具有调试器和与本地符号服务器的连接的任何计算机上调试这些构建中的崩溃和问题。如果您调试由不是自己构建的可执行文件（即由另一个程序员或构建机器生成的可执行文件）生成的小型转储，这将非常有用。如果这些构建的符号存储在符号服务器上，则将进行可靠和准确的调试。
*   使符号保持最新。当更新组件（例如由Windows Update或DirectX SDK修改的OS组件）时，仍可使用所有最新的符号进行调试。

在您自己的本地网络上设置符号服务器就像在服务器上创建文件共享一样简单，并为用户提供访问共享的完全权限，以创建文件和文件夹。此共享应在服务器操作系统（如Windows Server 2003）上创建，以便可以同时访问共享的人数不受限制。

例如，如果在\\ mainserver \ symbols上设置了文件共享，则您的团队成员将_NT_SYMBOL_PATH设置为以下内容：

Srv * c：\ symbols * \\ mainserver \ symbols * https：//msdl.microsoft.com/download/symbols

当检索符号时，文件和文件夹显示在\\ mainserver \ symbols共享目录中，以及单个高速缓存中c：\ symbols目录中。

这通常是设置和使用自己的符号服务器或Microsoft符号服务器所涉及的。
向符号服务器添加符号

要添加，删除或编辑符号服务器共享上的文件，请使用symstore.exe工具。此工具是Microsoft Debugging Tools for Windows软件包的一部分。符号服务器，symstore工具和索引符号的完整文档包含在Windows调试工具包中。

您可能需要将符号直接添加到自己的符号服务器，作为构建过程的一部分，或使符号可供整个团队使用第三方库或工具。将符号添加到符号服务器文件共享的过程称为索引符号。有两种常用的索引符号方法。符号文件可以复制到符号服务器。或者，指向符号位置的指针可以复制到符号服务器。如果您有一个包含旧版本的归档文件夹，您可能希望将指针索引到共享中已有的PDB文件，而不是复制符号。因为符号有时可以是几十兆字节的大小，所以最好提前计划在开发过程中归档项目的所有构建所需的空间。如果您只索引指向符号的指针，则如果删除旧版本或更改文件共享的名称，则可能会出现问题。

例如，要将从2006年10月的DirectX SDK获取的c：\ dxsym \ Extras \ Symbols中的所有符号递归索引到名为\\ mainserver \ symbols的符号服务器文件共享上，可以使用以下命令：

“c：\ Program Files \ Windows \ symstore的调试工具”add / f“C：\ dxsym \ Extras \ Symbols \ *。pdb”
/ s \\ mainserver \ symbols / t“2006年10月DirectX SDK”/ r

/ t“comment”参数用于向添加了符号的事务添加描述。在对符号执行管理任务时，这可能很有用。
最佳实践

*   为您的团队，公司或产品设置自己的符号服务器文件共享。
*   设置_NT_SYMBOL_PATH以指向本地缓存，专用符号服务器和Microsoft符号服务器。